<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>@coreui/coreui-free-angular-admin-template documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">@coreui/coreui-free-angular-admin-template documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>MenuProduct</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/analysis/menu-editor/menu-editor.component.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#product_category_id">product_category_id</a>
                                </li>
                                <li>
                                        <a href="#product_foodcost">product_foodcost</a>
                                </li>
                                <li>
                                        <a href="#product_id">product_id</a>
                                </li>
                                <li>
                                        <a href="#product_merged_code">product_merged_code</a>
                                </li>
                                <li>
                                        <a href="#product_name">product_name</a>
                                </li>
                                <li>
                                        <a href="#product_note">product_note</a>
                                </li>
                                <li>
                                        <a href="#product_sellprice">product_sellprice</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_category_id"></a>
                                        <span class="name"><b>product_category_id</b><a href="#product_category_id"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_category_id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_foodcost"></a>
                                        <span class="name"><b>product_foodcost</b><a href="#product_foodcost"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_foodcost:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_id"></a>
                                        <span class="name"><b>product_id</b><a href="#product_id"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_merged_code"></a>
                                        <span class="name"><b>product_merged_code</b><a href="#product_merged_code"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_merged_code:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_name"></a>
                                        <span class="name"><b>product_name</b><a href="#product_name"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_note"></a>
                                        <span class="name"><b>product_note</b><a href="#product_note"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_note:     <code>null</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>null</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="product_sellprice"></a>
                                        <span class="name"><b>product_sellprice</b><a href="#product_sellprice"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>product_sellprice:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { AfterViewInit, Component, Input, isDevMode, OnInit, ViewChild } from &#x27;@angular/core&#x27;;
import { NgbDateStruct } from &#x27;@ng-bootstrap/ng-bootstrap&#x27;;
import { GridApi } from &#x27;ag-grid-community&#x27;;
import { BaseTableComponent } from &#x27;../../prod-table/base-list.component&#x27;
import { Category } from &#x27;../../prod-table/cat-table.component&#x27;;
import { TableLib } from &#x27;../../prod-table/lib/table-lib&#x27;;
import { MenuTableComponent } from &#x27;./menu/menu-table.component&#x27;;
import { Product, ProductMerged } from &#x27;../../prod-table/prod-table.component&#x27;;
import { DateRangeComponent } from &#x27;../../views/daterange/daterange.component&#x27;;
import { NewMenuComponent } from &#x27;./newmenu/newmenu.component&#x27;;
import { red } from &#x27;@material-ui/core/colors&#x27;;

var print &#x3D; console.log.bind(console);


export interface MenuProduct {
  product_id: number,
  product_name: string,
  product_note: null,
  product_category_id: number,
  product_sellprice: number,
  product_foodcost: number,
  product_merged_code: number
}

@Component({
  selector: &#x27;app-menu-editor&#x27;,
  templateUrl: &#x27;./menu-editor.component.html&#x27;,
  styleUrls: [&#x27;./menu-editor.component.css&#x27;]
})



export class MenuEditorComponent extends BaseTableComponent implements OnInit, AfterViewInit {
  title &#x3D; &quot;Menu Editor&quot;;
  btnSave &#x3D; true;
  btnExport &#x3D; true;
  btnReload &#x3D; true;
  btnPrint &#x3D; true;

  @Input() messageService;    //refernce to message Service
  public rowDataProduct;
  public rowSelection &#x3D; &#x27;multiple&#x27;;

  public leftGridApi: GridApi;
  public rightGridApi: GridApi;


  public menuMenuHeader: string[] &#x3D; [];
  public menuSelected: string &#x3D; &#x27;Please select a menu&#x27;;
  public menuDescription: string &#x3D; &quot;&quot;;
  public SAVE_AS &#x3D; false;   //menu create / Save As flag modal

  public productXmenu: number[] &#x3D; [];

  @ViewChild(MenuTableComponent, { static: false }) menutable: MenuTableComponent;
  @ViewChild(DateRangeComponent, { static: false }) daterangeComponent: DateRangeComponent;
  @ViewChild(NewMenuComponent, { static: false }) newmenuComponent: NewMenuComponent;

  // right table
  columnDefs &#x3D; [
    {
      rowDrag: true,
      rowDragText: function (params, dragItemCount) {
        if (dragItemCount &gt; 1) {
          return dragItemCount + &#x27; product_merged_name&#x27;;
        }
        return params.rowNode.data.product_merged_name;
      },

      headerName: &#x27;Product&#x27;, field: &#x27;product_merged_name&#x27;, width: 100, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27;
    },
    { headerName: &#x27;&#x27;, field: &quot;product_merged_code&quot;, hide: true },
    {
      headerName: &#x27;Category&#x27;, field: &#x27;product_category_id&#x27;, width: 110, resizable: true, editable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;
    },
    {
      headerName: &#x27;Category&#x27;, field: &#x27;ccc_category_name&#x27;, resizable: true, editable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
    },
    { headerName: &#x27;Id&#x27;, field: &#x27;product_id&#x27;, width: 110, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Code&#x27;, field: &#x27;product_code&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Note&#x27;, field: &#x27;product_note&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    {
      headerName: &#x27;Sell_price&#x27;, field: &#x27;product_sellprice&#x27;, width: 150, editable: true,
      resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
      valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    },
    // { headerName: &#x27;Qty&#x27;, field: &#x27;product_quantity&#x27;, width: 130, editable: true, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Description&#x27;, field: &#x27;product_description&#x27;, resizable: true, editable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Discount&#x27;, field: &#x27;product_discount&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Enabled&#x27;, field: &#x27;product_enabled&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Kasavana cat&#x27;, field: &#x27;product_kasavana_category&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Source&#x27;, field: &#x27;product_input_source&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    {
      headerName: &#x27;Food_cost&#x27;, field: &#x27;product_foodcost&#x27;, resizable: true, editable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;, width: 150,
      valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    },
    {
      headerName: &#x27;Contribution&#x27;, field: &#x27;ccc_contribution&#x27;, width: 110, resizable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
      valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    },
    {
      headerName: &#x27;Incidence&#x27;, field: &#x27;ccc_incidence&#x27;, width: 110, resizable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
      valueFormatter: params &#x3D;&gt; TableLib.percentageFormatter(params.value),
    },
  ];

  // left table
  columnDefs2 &#x3D; [
    {
      rowDrag: true,
      rowDragText: function (params, dragItemCount) {
        if (dragItemCount &gt; 1) {
          return dragItemCount + &#x27; products&#x27;;
        }
        return params.rowNode.data.name;
      },
      headerName: &#x27;&#x27;, field: &quot;id&quot;, dndSource: false, width: 40
    },
    // { headerName: &#x27;Category&#x27;, field: &#x27;product_category_id&#x27;, width: 110, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    {
      headerName: &#x27;Product&#x27;, field: &#x27;name&#x27;, width: 110, sortable: true, resizable: true, editable: true
    },
    { headerName: &#x27;&#x27;, field: &quot;product_merged_code&quot;, hide: true },
    {
      headerName: &#x27;Category&#x27;, field: &#x27;ccc_category_name&#x27;, resizable: true,
      sortable: true, filter: &#x27;agTextColumnFilter&#x27;, width: 110
    },
    { headerName: &#x27;Id&#x27;, field: &#x27;product_id&#x27;, width: 110, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Product&#x27;, field: &#x27;product_name&#x27;, width: 300, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Code&#x27;, field: &#x27;product_code&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // {
    //   headerName: &#x27;Sell_price&#x27;, field: &#x27;product_sell_price&#x27;, width: 150,
    //   resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
    //   valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    // },
    { headerName: &#x27;Note&#x27;, field: &#x27;product_note&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Qty&#x27;, field: &#x27;product_quantity&#x27;, width: 130, editable: true, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Description&#x27;, field: &#x27;product_description&#x27;, resizable: true, editable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Discount&#x27;, field: &#x27;product_discount&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Enabled&#x27;, field: &#x27;product_enabled&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Kasavana cat&#x27;, field: &#x27;product_kasavana_category&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // { headerName: &#x27;Source&#x27;, field: &#x27;product_input_source&#x27;, resizable: true, sortable: true, filter: &#x27;agTextColumnFilter&#x27; },
    // {
    //   headerName: &#x27;Food_cost&#x27;, field: &#x27;product_food_cost_ext&#x27;, resizable: true, 
    //   sortable: true, filter: &#x27;agTextColumnFilter&#x27;, width: 110,
    //   valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    // },
    // {
    //   headerName: &#x27;Contribution&#x27;, field: &#x27;ccc_contribution&#x27;, width: 110, resizable: true,
    //   sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
    //   valueFormatter: params &#x3D;&gt; TableLib.currencyFormatter(params.value),
    // },
    // {
    //   headerName: &#x27;Incidence&#x27;, field: &#x27;ccc_incidence&#x27;, width: 110, resizable: true,
    //   sortable: true, filter: &#x27;agTextColumnFilter&#x27;,
    //   valueFormatter: params &#x3D;&gt; TableLib.percentageFormatter(params.value),
    // },
  ];
  newMenu_unsaved: boolean;


  ngAfterViewInit() {
    // needed to correctly update daterange in daterangeComponent
    this.cdRef.detectChanges();
    // this.refreshData();
    setTimeout(() &#x3D;&gt; { this.refreshData() });

    //select menu
    setTimeout(() &#x3D;&gt; {
      const menuSelected &#x3D; sessionStorage.getItem(&#x27;menuSelected&#x27;);
      if (menuSelected)
        this.onMenuSelect(this.menuMenuHeader.findIndex(v &#x3D;&gt; v &#x3D;&#x3D; menuSelected));
      // this.menuSelected &#x3D; menuSelected;
    });
  }


  ngOnInit() {

    // receive updates about selected structure
    this.globalService.selectedStructure.subscribe(async message &#x3D;&gt; {
      if (message) {
        setTimeout(() &#x3D;&gt; {
          this.refreshData();
          this.menutable.refreshData();
          this.menuSelected &#x3D; &#x27;Please select a menu&#x27;;
        });
      }
    });
  }


  // needed bt drag &amp; drop function
  getRowNodeId(data) {
    if (data &#x3D;&#x3D; undefined)
      return;
    return data.product_id;
  }

  // set row style by parameter LEFTGRID
  getRowStyle1(params) {
    // console.log(&quot;ciao&quot;);
    if (params.node.data &amp;&amp; params.node.data.changed)
      return { background: &#x27;#5bc0de&#x27; };

  }

  // cell edited on aggrid
  onCellValueChanged(params) {
    params.node.data[&#x27;changed&#x27;] &#x3D; true
    this.unsaved &#x3D; true;

    //recalculate incidence
    params.node.data.ccc_contribution &#x3D; Number(params.node.data.product_sellprice) - Number(params.node.data.product_foodcost);
    params.node.data.ccc_incidence &#x3D; Number(params.node.data.product_foodcost) / Number(params.node.data.product_sellprice) * 100;

    params.colDef.cellStyle &#x3D; function (params2) {
      if (params2.node.data[&#x27;changed&#x27;] || params2.node.data[&#x27;groupChange&#x27;])
        return { color: &#x27;red&#x27; };
    }
    this.gridApi.redrawRows();


  }

  


  /******************************************************** */
  onLeftGridReady(params) {
    this.leftGridApi &#x3D; params.api;
  }

  /******************************************************** */
  onRightGridReady(params) {
    this.rightGridApi &#x3D; params.api;
    this.gridApi &#x3D; params.api;  // needed by export button

    const self &#x3D; this;

    // DRAG &amp; DROP code
    // set drop zone in right grid
    var dropZoneParams &#x3D; params.api.getRowDropZoneParams({
      onDragStop: (params) &#x3D;&gt; {
        var nodes &#x3D; params.nodes;
        nodes.forEach(node &#x3D;&gt; {
          let data &#x3D; node.data;
          data[&#x27;changed&#x27;] &#x3D; true; // set changed field
          // calculate incidence &amp; contribution
          data[&#x27;ccc_contribution&#x27;] &#x3D; +(data.product_sellprice - data.product_foodcost).toFixed(1);
          data[&#x27;ccc_incidence&#x27;] &#x3D; +(data.product_foodcost / data.product_sellprice * 100).toFixed(1);
          params.api.refreshCells();  //refresh to show new values
        });
        self.unsaved &#x3D; true;  //set unsaved flag
      }
    });
    // set drag-drop zone in left grid
    this.leftGridApi.addRowDropZone(dropZoneParams);
  }




  /*****************************************************
  *   select category dropdown
  */
  async onMenuSelect(i) {
    this.menuSelected &#x3D; this.menuMenuHeader[i];  // select item
    sessionStorage.setItem(&#x27;menuSelected&#x27;, this.menuSelected);
    this.updateTable();
  }

  /******************************************************
   * Called from children table
   */
  onMenuTableSelectionChanged(params) {
    // console.log(&quot;Children table - event received&quot;, params);
    this.menuSelected &#x3D; params;
    sessionStorage.setItem(&#x27;menuSelected&#x27;, this.menuSelected);
    this.updateTable();
  }

  /******************************************************
   * Called from File -&gt; New
   * Modal dialog data
   */
  async createSaveMenu() {
    const menuData &#x3D; this.newmenuComponent.menuForm.value;
    /**
         menu_name : new FormControl(&#x27;&#x27;),
         menu_from : new FormControl(&#x27;&#x27;),
         menu_to : new FormControl(&#x27;&#x27;),
         menu_description : new FormControl(&#x27;&#x27;)
     */
    // console.log(&quot;New menu&quot;, menuData);
    // const oldRowData &#x3D; this.rowData;        // save rowData
    const oldRowData &#x3D; this.rowData;

    this.menutable.insertNewRow(menuData);  // attention this will trigger a row select event and update rightGridApi
    this.menuDescription &#x3D; menuData.menu_description;
    this.unsaved &#x3D; true;
    this.newMenu_unsaved &#x3D; true;
    if (!this.SAVE_AS) {
      this.rowData &#x3D; [];
      this.messageService.show(&quot;Created new Menu : &quot; + menuData.menu_name);
    }
    else {
      // set all rows as changed  
      // TODO not working
      // setTimeout(async () &#x3D;&gt; {
      this.rowData &#x3D; oldRowData;    // restore table data
      this.rightGridApi.setRowData(this.rowData);
      this.rightGridApi.forEachNode(row &#x3D;&gt; { row.data.changed &#x3D; true; });
      await this.saveTable();
      this.SAVE_AS &#x3D; false;
      // }, 1000);
    }
    // push to dropdown
    this.menuMenuHeader.push(menuData.menu_name);
  }


  /*****************************************************
  *   Table update - right and left 
  */
  async updateTable() {
    this.loading &#x3D; true;


    // Update ALL Product table
    const prodArr: Product[] &#x3D; await this.awsService.getProducts();
    let prodMerged: ProductMerged[] &#x3D; await this.awsService.getProductMergeds();
    const catArr: Category[] &#x3D; await this.awsService.getCategories();

    // convert to unique array
    function uniq(a) {
      var seen &#x3D; {};
      return a.filter(function (item) {
        return seen.hasOwnProperty(item.name) ? false : (seen[item.name] &#x3D; true);
      });
    }
    prodMerged &#x3D; uniq(prodMerged);

    prodMerged.forEach(row &#x3D;&gt; {   // for each row in table Product Merged
      const prodFound &#x3D; prodArr.find(x &#x3D;&gt; x.product_id &#x3D;&#x3D; row.product_id);  // find corresponding category
      if (prodFound) {
        row[&#x27;product_merged_name&#x27;] &#x3D; row.name;   // assign name instead of ID
        row[&#x27;product_merged_code&#x27;] &#x3D; row.code;   // assign name instead of ID
        row[&#x27;product_note&#x27;] &#x3D; prodFound.product_note;   // assign name instead of ID
        row[&#x27;product_sellprice&#x27;] &#x3D; prodFound.product_sell_price;   // assign name instead of ID
        row[&#x27;product_foodcost&#x27;] &#x3D; prodFound.product_food_cost_ext;   // assign name instead of ID

        const catFound &#x3D; catArr.find(x &#x3D;&gt; x.categoryid &#x3D;&#x3D; String(prodFound.product_category_id));  // find corresponding category
        if (catFound !&#x3D; undefined) {
          row[&#x27;ccc_category_name&#x27;] &#x3D; catFound.name;   // assign name instead of ID
          row[&#x27;product_category_id&#x27;] &#x3D; catFound.categoryid;   // assign name instead of ID
        }
      }
    });

    this.rowDataProduct &#x3D; prodMerged;


    // Update Selected MENU table
    const menus &#x3D; await this.awsService.getMenus(true); // get all menus
    const menuFound &#x3D; menus.find(x &#x3D;&gt; x.menu_name &#x3D;&#x3D; this.menuSelected);  // find corresponding menu
    if (!menuFound) // can happen when new menu is created and not saved yet
      return;
    this.menuDescription &#x3D; menuFound.menu_description;  // load description

    // list of products
    const data &#x3D; menuFound.menu_products;

    if (data !&#x3D; undefined) {  // if table has rows
      data.forEach(mp &#x3D;&gt; {   // for each mp in table Product
        // find corresponding category
        const catFound &#x3D; catArr.find(x &#x3D;&gt; x.categoryid &#x3D;&#x3D; String(mp.product_category_id));
        if (catFound !&#x3D; undefined)
          mp[&#x27;ccc_category_name&#x27;] &#x3D; catFound.name;   // assign name instead of ID

        mp[&#x27;ccc_contribution&#x27;] &#x3D; +(Number(mp[&#x27;product_sellprice&#x27;]) - Number(mp[&#x27;product_foodcost&#x27;])).toFixed(1);
        mp[&#x27;ccc_incidence&#x27;] &#x3D; +(Number(mp[&#x27;product_foodcost&#x27;]) / Number(mp[&#x27;product_sellprice&#x27;]) * 100).toFixed(1);
      });

      // console.log(&quot;received: &quot;, data);
      this.rowData &#x3D; data;              // assign new data table
    }
    else {
      // this.messageService.show(&quot;Menu is empty.&quot;);
      this.rowData &#x3D; [];
    }

    this.rightGridApi.sizeColumnsToFit();  // resize column width
    this.rightGridApi.refreshCells();      // refhresh table
    this.loading &#x3D; false;
  }


  /*************************************************************************
   *  get and modify data to display  
   */
  async getData(): Promise&lt;any[]&gt; {
    return await this.awsService.getMenus();
  }

  /**************************************************
  * extends Refresh data
  */
  public async refreshData() {

    // check store selected
    if (!this.awsService.getStrId()) {
      this.messageService.show(&quot;Please select a Store.&quot;)
      return;
    }

    this.loading &#x3D; true;


    const menuArr &#x3D; await this.menutable.getData();
    this.menuMenuHeader &#x3D; menuArr.map(menu &#x3D;&gt; menu.menu_name);

    menuArr.forEach(menu &#x3D;&gt; {
      const count &#x3D; menu.menu_products ? menu.menu_products.length : 0;
      this.productXmenu.push(count);
    });

    this.loading &#x3D; false;             // reset loading spinner 
  }


  refresh &#x3D; () &#x3D;&gt; {
    if (this.canDeactivate()) {
      this.unsaved &#x3D; false;
      this.refreshData();
      this.updateTable();
    }

  }

  /********************************************************
*  Reload button pressed
*/
  reload &#x3D; () &#x3D;&gt; {
    this.awsService.clearSession(&#x27;product&#x27;);
    this.awsService.clearSession(&#x27;productGroup&#x27;);
    this.refresh();
  }

  deleteSelectedRow(value) {
    const selectedRows &#x3D; this.gridApi.getSelectedNodes();
    selectedRows.forEach(row &#x3D;&gt; this.disableRow(row.data, value));
    if (selectedRows.length) {
      this.unsaved &#x3D; true;
      this.gridApi.redrawRows();   // need redraw
    }
  }

  // right button mouse context menu
  getContextMenuItems &#x3D; (params) &#x3D;&gt; {

    // select left or right
    if (params.api &#x3D;&#x3D; this.leftGridApi)
      return [
        {
          name: &#x27;Autosize Columns&#x27;,           // copy field
          action: () &#x3D;&gt; {
            params.api.sizeColumnsToFit();
          }
        },
        {
          name: &#x27;Copy&#x27;,           // copy field
          action: () &#x3D;&gt; {
            this.onMenuClipboard(params.value);
          }
        },
      ];

    if (params.api &#x3D;&#x3D; this.rightGridApi)
      return [
        {
          name: &#x27;Delete&#x27;,     // delete row
          tooltip: &#x27;Delete selected Row&#x27;,
          action: async () &#x3D;&gt; {
            params.node.setSelected(true);  // if right click then select
            this.deleteSelectedRow(true);
          }
        },
        {
          name: &#x27;Undelete&#x27;,     // delete row
          tooltip: &#x27;Undelete selected Row&#x27;,
          action: async () &#x3D;&gt; {
            params.node.setSelected(true);  // if right click then select
            this.deleteSelectedRow(false);
          }
        },
        {
          name: &#x27;Autosize Columns&#x27;,           // copy field
          action: () &#x3D;&gt; {
            params.api.sizeColumnsToFit();
          }
        },
        {
          name: &#x27;Copy&#x27;,           // copy field
          action: () &#x3D;&gt; {
            this.onMenuClipboard(params.value);
          }
        },
        {
          name: &#x27;Export&#x27;,
          tooltip: &#x27;Export table&#x27;,
          subMenu: [
            {
              name: &#x27;Export as csv&#x27;,
              action: () &#x3D;&gt; {
                params.api.exportDataAsCsv(params);
              }
            },
            {
              name: &#x27;Export to Excel&#x27;,
              action: () &#x3D;&gt; {
                params.api.exportDataAsExcel(params);
              }
            }
          ] //end row submenu
        }

      ];

  }

  autoSize() {
    this.gridApi.sizeColumnsToFit();
  }

  /********************************************************
  *  Save button pressed
  */
  saveTable &#x3D; async () &#x3D;&gt; {
    if (!this.unsaved) {  // nothing to save
      this.messageService.show(&quot;Data already up-to-date. Nothing to save.&quot;);
      return;
    }

    // if menu is new then first save menu
    if (this.newMenu_unsaved) {
      await this.menutable.saveTable();
      this.newMenu_unsaved &#x3D; false;
    }

    // Update Selected MENU table
    this.awsService.clearSession(&#x27;menu&#x27;);   // clear cache
    const menus &#x3D; await this.awsService.getMenus(); // reload all menus
    const menuFound &#x3D; menus.find(x &#x3D;&gt; x.menu_name &#x3D;&#x3D; this.menuSelected);  // find corresponding menu
    let catArr &#x3D; await this.awsService.getCategories();
    const prodArr &#x3D; await this.awsService.getProducts();

    // save menu product
    let menuProductToSave: MenuProduct[] &#x3D; []; // array of MenuProducts to save
    let menuProductToDelete: number[] &#x3D; []; // array of products ID to delete
    let categoryToSave: Category[] &#x3D; [];
    let productToSave: Product[] &#x3D; [];

    this.rightGridApi.forEachNode(async row &#x3D;&gt; {
      const mp: MenuProduct &#x3D; row.data;
      if (mp[&#x27;changed&#x27;]) {
        if (mp[&#x27;deleted&#x27;]) {
          // Update Selected MENU table
          menuProductToDelete.push(mp.product_merged_code);
          // update table
          this.rightGridApi.applyTransaction({ remove: [row.data] });
        }
        else {
          // load all fields before change
          const original_product &#x3D; prodArr.find(p &#x3D;&gt; p.product_id &#x3D;&#x3D; mp.product_id);
          const original_category &#x3D; catArr.find(c &#x3D;&gt; c.categoryid &#x3D;&#x3D; String(mp.product_category_id));
          let original_mp;
          let changed_SELLPRICE &#x3D; false;
          let changed_FOODCOST &#x3D; false;
          if (menuFound.menu_products) {
            // check which field has changed
            original_mp &#x3D; menuFound.menu_products.find(o &#x3D;&gt; o.product_id &#x3D;&#x3D; mp.product_id);
            if (original_mp) {  // if new product added, original_mp is undefined
              changed_SELLPRICE &#x3D; mp[&#x27;product_sellprice&#x27;] !&#x3D; original_mp[&#x27;product_sellprice&#x27;];
              changed_FOODCOST &#x3D; mp[&#x27;product_foodcost&#x27;] !&#x3D; original_mp[&#x27;product_foodcost&#x27;];
            }
          }
          // check which field has changed
          const changed_CATID &#x3D; mp.product_category_id !&#x3D; original_product.product_category_id;
          const changed_CATNAME &#x3D; original_category ? mp[&quot;ccc_category_name&quot;] !&#x3D; original_category.name : true;

          // condition to save menuproduct
          if (changed_SELLPRICE || changed_FOODCOST || !original_mp)
            menuProductToSave.push(mp);

          // changed category ID
          if (changed_CATID || changed_CATNAME) {// check for category exist
            const category_EXIST &#x3D; catArr.find(c &#x3D;&gt; c.categoryid &#x3D;&#x3D; String(mp.product_category_id));
            if (!category_EXIST) {
              // create new Category
              const category: Category &#x3D; {
                categoryid: undefined,  // new category
                code: &quot;&quot;,
                description: &quot;&quot;,
                max_perc_cost: 0,
                max_price_revenue: 0,
                name: row.data[&quot;ccc_category_name&quot;],  // put new category name
                visible: true
              }
              categoryToSave.push(category);
              // update category into product
              original_product.product_category_id &#x3D; mp.product_category_id;
              productToSave.push(original_product);
            }
            else { // id changed but category EXIST
              if (changed_CATNAME &amp;&amp; !changed_CATID) {
                // update category name
                original_category.name &#x3D; mp[&quot;ccc_category_name&quot;];
                categoryToSave.push(original_category);
              }
              else if (changed_CATID) {
                // update category into product
                original_product.product_category_id &#x3D; Number(mp.product_category_id);
                productToSave.push(original_product);
                if (changed_CATNAME) {
                  // update category name
                  original_category.name &#x3D; mp[&quot;ccc_category_name&quot;];
                  categoryToSave.push(original_category);
                }
              }
            }
          }
        }
      }
      delete row.data.changed;
    });

    let messageString &#x3D; &quot;&quot;;
    // save product 
    if (menuProductToSave.length &gt; 0) {
      await this.awsService.saveMenuProducts(menuFound.menu_id, menuProductToSave);
      this.awsService.clearSession(&#x27;menu&#x27;); // clear cache
      messageString +&#x3D; &quot; Menu lines saved:&quot; + menuProductToSave.length;
    }
    // save menu (menuProduct)
    if (menuProductToDelete.length &gt; 0) {
      await this.awsService.deleteMenuProducts(menuFound.menu_id, menuProductToDelete);
      this.awsService.clearSession(&#x27;menu&#x27;); // clear cache
      messageString +&#x3D; &quot; Menu lines deleted:&quot; + menuProductToSave.length;
    }

    // save catagories
    if (categoryToSave.length &gt; 0) {
      const result &#x3D; await this.awsService.saveCategorys(categoryToSave);
      messageString +&#x3D; &quot; Category saved:&quot; + categoryToSave.length;
      // get new gateogory ID assigned by AWS
      if (result &amp;&amp; result[&#x27;data&#x27;]) {
        const data &#x3D; JSON.parse(result[&#x27;data&#x27;]);
        data.forEach((v, i) &#x3D;&gt; {
          // update products with new category ID
          productToSave[i].product_category_id &#x3D; Number(v[&#x27;category_id&#x27;]);
          // console.log(&quot; new category id: &quot;, productToSave[i]);
        });
      }
      this.awsService.clearSession(&#x27;categories&#x27;); // clear cache
    }
    // save product
    if (productToSave.length &gt; 0) {
      await this.awsService.saveProducts(productToSave);
      messageString +&#x3D; &quot; Product saved:&quot; + productToSave.length;
      this.awsService.clearSession(&#x27;product&#x27;);
    }

    // update view (always disalbe cache!!)
    this.updateTable();
    this.unsaved &#x3D; false;

    if (messageString &#x3D;&#x3D; &quot;&quot;)
      messageString &#x3D; &quot;Saved.&quot;
    this.messageService.show(messageString);
  }


  /*************************************************************************+
   * Add product with double click
   */
  onRowDoubleClick(event) {
    const product &#x3D; &lt;MenuProduct&gt;event.data;

    // do nothing if row is already in the grid, otherwise we would have duplicates
    var rowAlreadyInGrid &#x3D; !!this.rightGridApi.getRowNode(String(product.product_id)); // !! cast to boolean
    if (rowAlreadyInGrid) {
      this.messageService.show(&#x27;Item duplicate: please avoid duplicates in the grid&#x27;);
      return;
    }

    product[&#x27;changed&#x27;] &#x3D; true; // set changed field
    // calculate incidence &amp; contribution
    product[&#x27;ccc_contribution&#x27;] &#x3D; +(product.product_sellprice - product.product_foodcost).toFixed(1);
    product[&#x27;ccc_incidence&#x27;] &#x3D; +(product.product_foodcost / product.product_sellprice * 100).toFixed(1);
    // product.product_sellprice &#x3D; product.product_sell_price;
    // product.product_foodcost &#x3D; product.product_food_cost_ext;

    // product.product_sellprice_original &#x3D; product.product_sell_price;  //need because empty
    this.rightGridApi.applyTransaction({ add: [product] });
    this.unsaved &#x3D; true;
    // console.log(&quot;Double click product&quot;);
    this.leftGridApi.redrawRows();
  }

    /*********************************** 
   * Extends parent function
  */
 public printPrepare(value: boolean) {
  if (value) {
    this.rightGridApi.setDomLayout(&#x27;print&#x27;);
    this.leftGridApi.setDomLayout(&#x27;print&#x27;);
  }
  else {
    this.rightGridApi.setDomLayout(&#x27;normal&#x27;);
    this.leftGridApi.setDomLayout(&#x27;normal&#x27;);
  }
}
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'MenuProduct.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
